<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GANT Exchange Prototype</title>
</head>
<body>
  <h1>GANT Exchange Prototype</h1>

  <!-- Auth Buttons -->
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Signup</button>
  <button id="logoutBtn" style="display:none;">Logout</button>

  <!-- Trades List -->
  <h2>Trades List</h2>
  <ul id="trades"></ul>

  <!-- Add a Trade -->
  <h2>Add a Trade</h2>
  <input type="text" id="farmerName" placeholder="Farmer Name">
  <input type="text" id="buyerName" placeholder="Buyer Name">
  <input type="text" id="commodity" placeholder="Commodity (e.g., Wheat)">
  <input type="number" id="quantity" placeholder="Quantity (tons)">
  <input type="number" id="price" placeholder="Price ($/ton)">
  <button id="addTradeBtn">Add Trade</button>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    // Load trades
    async function loadTrades() {
      const { data, error } = await supabase.from('trades').select('*');
      if (error) {
        console.error("Error fetching trades:", error.message);
        alert("Error loading trades: " + error.message);
        return;
      }

      const list = document.getElementById('trades');
      list.innerHTML = "";

      data.forEach(trade => {
        const li = document.createElement('li');
        li.textContent = `${trade.farmer_name} sold ${trade.quantity} tons of ${trade.commodity} to ${trade.buyer_name} @ $${trade.price}/ton`;

        // Delete button
        const delBtn = document.createElement('button');
        delBtn.textContent = "Delete Trade";
        delBtn.style.marginLeft = "10px";
        delBtn.onclick = async () => {
          const { error } = await supabase.from('trades').delete().eq('id', trade.id);
          if (error) {
            console.error("Error deleting trade:", error.message);
            alert("Delete failed: " + error.message);
          } else {
            loadTrades(); // refresh after delete
          }
        };

        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    // Add trade
    async function addTrade() {
      const farmer = document.getElementById('farmerName').value.trim();
      const buyer = document.getElementById('buyerName').value.trim();
      const commodity = document.getElementById('commodity').value.trim();
      const quantity = parseInt(document.getElementById('quantity').value);
      const price = parseFloat(document.getElementById('price').value);

      if (!farmer || !buyer || !commodity || !quantity || !price) {
        alert("Please fill all fields");
        return;
      }

      const { error } = await supabase.from('trades').insert([{
        farmer_name: farmer,
        buyer_name: buyer,
        commodity,
        quantity,
        price
      }]);

      if (error) {
        console.error("Error inserting trade:", error.message);
        alert("Insert failed: " + error.message);
        return;
      }

      // Clear inputs
      document.getElementById('farmerName').value = "";
      document.getElementById('buyerName').value = "";
      document.getElementById('commodity').value = "";
      document.getElementById('quantity').value = "";
      document.getElementById('price').value = "";

      loadTrades();
    }

    document.getElementById('addTradeBtn').addEventListener('click', addTrade);

    // Initial load
    loadTrades();
  </script>
</body>
</html>
